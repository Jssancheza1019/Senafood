<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${producto.idProducto != null} ? 'Editar Producto' : 'Crear Producto'">Formulario Producto</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" th:href="@{/css/producto/form.css}">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
</head>
<body>
    <div class="container">
        <div class="header">
            <h2 th:text="${producto.idProducto != null} ? 'Editar Producto' : 'Crear Producto'"></h2>
        </div>

        <div class="mb-6">
            <a th:href="@{/producto}" class="btn btn-regresar flex items-center space-x-2">
                <i class="fas fa-arrow-left"></i>
                <span>Regresar a Productos</span>
            </a>
        </div>
        
        <div class="card">
            <div class="card-body">
                <form th:action="${producto.idProducto != null} ? 
                                     @{/producto/update/{id}(id=${producto.idProducto})} : 
                                     @{/producto/store}" 
                      method="post" 
                      enctype="multipart/form-data"
                      th:object="${producto}"> 
                    
                    <input type="hidden" name="idProducto" th:value="${producto.idProducto}" />
                    
                    <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger">
                        <h5>Errores de validación:</h5>
                        <ul>
                            <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                        </ul>
                    </div>
                    
                    <div class="form-group">
                        <label for="nombre">Nombre *</label>
                        <input type="text" id="nombre" th:field="*{nombre}" 
                            class="form-control" required 
                            placeholder="Ej: CocaCola 250ml">
                        <div th:if="${#fields.hasErrors('nombre')}" class="text-danger">
                            <small th:errors="*{nombre}"></small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="descripcion">Descripción</label>
                        <textarea id="descripcion" th:field="*{descripcion}" 
                                     class="form-control" rows="3"
                                     placeholder="Descripción breve del producto..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="costoUnitario">Costo Unitario *</label>
                                <input type="number" id="costoUnitario" th:field="*{costoUnitario}" 
                                    class="form-control" 
                                    step="0.01" min="0.01" required 
                                    placeholder="0.00">
                                <div th:if="${#fields.hasErrors('costoUnitario')}" class="text-danger">
                                    <small th:errors="*{costoUnitario}"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="stock">Stock *</label>
                                <input type="number" id="stock" th:field="*{stock}" 
                                    class="form-control" 
                                    min="0" required 
                                    placeholder="0">
                                <div th:if="${#fields.hasErrors('stock')}" class="text-danger">
                                    <small th:errors="*{stock}"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="fechaVencimiento">Fecha de Vencimiento *</label>
                        <input type="date" id="fechaVencimiento" th:field="*{fechaVencimiento}" 
                            class="form-control" required>
                        <div th:if="${#fields.hasErrors('fechaVencimiento')}" class="text-danger">
                            <small th:errors="*{fechaVencimiento}"></small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="categoria">Categoría</label>
                                <input type="text" id="categoria" th:field="*{categoria}" 
                                    class="form-control" 
                                    placeholder="Ej: Bebidas Gaseosas">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="codigoBarras">Código de Barras</label>
                                <input type="text" id="codigoBarras" th:field="*{codigoBarras}" 
                                    class="form-control" 
                                    placeholder="Opcional">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="estado">Estado</label>
                        <select id="estado" th:field="*{estado}" class="form-control">
                            <option value="activo">Activo</option>
                            <option value="inactivo">Inactivo</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="imagenFile">Imagen</label>
                        <input type="file" id="imagenFile" name="imagenFile" class="form-control" 
                            accept="image/*">
                        
                        <div th:if="${producto.imagen != null and producto.imagen != ''}" class="mt-2">
                            <p><strong>Imagen actual:</strong> <span th:text="${producto.imagen}"></span></p>
                            <img th:src="@{'/img/productos/' + ${producto.imagen}}" 
                                alt="Imagen del producto" 
                                class="img-thumbnail">
                            <div class="form-check mt-2">
                                <input type="checkbox" name="eliminarImagen" value="true" 
                                    class="form-check-input" id="eliminarImagen">
                                <label class="form-check-label text-danger" for="eliminarImagen">
                                    Eliminar imagen actual
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" th:field="*{idInventario}" />
                    
                    <div class="form-group mt-4">
                        <button type="submit" class="btn btn-primary">
                            <span th:text="${producto.idProducto != null} ? 'Actualizar Producto' : 'Guardar Producto'"></span>
                        </button>
                        <a th:href="@{/producto}" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Lógica para establecer fecha mínima para hoy y valor por defecto (si es necesario)
        const fechaInput = document.getElementById('fechaVencimiento');
        if (fechaInput) {
            const hoy = new Date().toISOString().split('T')[0];
            
            // Establece la fecha mínima para evitar ingresar fechas pasadas
            fechaInput.min = hoy;
            
            // Si el campo está vacío, establece la fecha por defecto (ej: 30 días a partir de hoy)
            if (!fechaInput.value) {
                const fechaDefault = new Date();
                fechaDefault.setDate(fechaDefault.getDate() + 30);
                fechaInput.value = fechaDefault.toISOString().split('T')[0];
            }
        }
        
        // Validación básica (mantenida de tu código)
        document.querySelector('form').addEventListener('submit', function(e) {
            const precio = document.getElementById('costoUnitario');
            const stock = document.getElementById('stock');
            
            if (precio && parseFloat(precio.value) <= 0) {
                alert('El costo unitario debe ser mayor que 0');
                e.preventDefault();
                return false;
            }
            
            if (stock && parseInt(stock.value) < 0) {
                alert('El stock no puede ser negativo');
                e.preventDefault();
                return false;
            }
            
            return true;
        });
    </script>
</body>
</html>