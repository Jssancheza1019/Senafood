<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SenaFOOD - Panel de PQRSF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            padding: 2rem;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        .table-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow-x: auto; /* Permite desplazamiento horizontal en móviles */
        }
        th, td {
            white-space: nowrap; /* Evita que el contenido de las celdas se envuelva */
            padding: 12px 16px;
        }
        th {
            background-color: #384d30; /* Verde oscuro SenaFOOD */
            color: white;
            text-align: left;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 9999px; /* rounded-full */
            font-size: 0.75rem;
            font-weight: 700;
        }
        .status-Pendiente { background-color: #fcd34d; color: #92400e; } /* Amarillo/Naranja */
        .status-EnProceso { background-color: #93c5fd; color: #1e40af; } /* Azul */
        .status-Resuelta { background-color: #a7f3d0; color: #065f46; } /* Verde Claro */
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center md:text-left">Panel de Peticiones, Quejas, Reclamos, Sugerencias y Felicitaciones (PQRSF)</h1>

    <div id="loading-message" class="text-center py-10 text-lg text-gray-600">
        Cargando solicitudes...
    </div>

    <div id="error-message" class="hidden text-center py-10 text-xl text-red-600 font-bold">
        ❌ Error al cargar los datos. Verifique el servidor.
    </div>

    <div class="table-container hidden" id="pqrsf-table-container">
        <table class="min-w-full divide-y divide-gray-200">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tipo</th>
                    <th>Descripción</th>
                    <th>Estado</th>
                    <th>Usuario ID</th> <!-- Columna ajustada para idUsuario -->
                    <th>Carrito/Orden ID</th> <!-- Columna para idCarrito -->
                    <th>Fecha Creación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" id="pqrsf-tbody">
                <!-- Las filas de datos se insertarán aquí por JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const tableContainer = document.getElementById('pqrsf-table-container');
        const tbody = document.getElementById('pqrsf-tbody');
        const API_URL = '/api/pqrsf'; 

        // Función para formatear la fecha
        const formatDate = (isoString) => {
            if (!isoString) return 'N/A';
            try {
                // Intenta crear un objeto Date directamente si es un string de fecha/hora
                const date = new Date(isoString);
                return date.toLocaleString('es-CO', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } catch (e) {
                return 'Fecha Inválida';
            }
        };

        // Función para cambiar el estado
        const handleStatusChange = async (id, newStatus, buttonElement) => {
            if (!confirm(`¿Está seguro de cambiar el estado de la PQRSF #${id} a ${newStatus}?`)) {
                return;
            }

            const originalText = buttonElement.textContent;
            buttonElement.disabled = true;
            buttonElement.textContent = 'Guardando...';

            try {
                const response = await fetch(`${API_URL}/${id}/status?newStatus=${newStatus}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    // No necesita body para PATCH con RequestParam
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                // Recargar los datos para actualizar la fila
                fetchPqrsfData();

            } catch (error) {
                console.error(`Error al actualizar el estado de PQRSF #${id}:`, error);
                alert(`Error al actualizar: ${error.message}`);
                buttonElement.textContent = originalText;
                buttonElement.disabled = false;
            }
        };

        // Función principal para obtener y renderizar los datos
        const fetchPqrsfData = async () => {
            loadingMessage.classList.remove('hidden');
            tableContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            tbody.innerHTML = ''; // Limpiar tabla

            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`El servidor respondió con estado: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.length === 0) {
                    loadingMessage.textContent = "No hay solicitudes PQRSF registradas.";
                    return;
                }

                data.forEach(item => {
                    const row = tbody.insertRow();
                    
                    // Columna 1: ID
                    row.insertCell().textContent = item.id;
                    
                    // Columna 2: Tipo
                    row.insertCell().textContent = item.tipo;

                    // Columna 3: Descripción (Truncada para la vista de tabla)
                    const descCell = row.insertCell();
                    descCell.textContent = item.descripcion.substring(0, 50) + (item.descripcion.length > 50 ? '...' : '');
                    descCell.title = item.descripcion; // Tooltip con la descripción completa

                    // Columna 4: Estado (con badge de color)
                    const statusCell = row.insertCell();
                    const statusText = item.estado || 'Pendiente';
                    statusCell.innerHTML = `<span class="status-badge status-${statusText.replace(/\s/g, '')}">${statusText}</span>`;

                    // Columna 5: Usuario ID (Más informativo)
                    // Nota: En un sistema real, harías un JOIN para obtener el nombre del usuario.
                    row.insertCell().textContent = `Usuario #${item.idUsuario}`;
                    
                    // Columna 6: Carrito ID (Muestra N/A si es null)
                    row.insertCell().textContent = item.idCarrito ? `Orden #${item.idCarrito}` : 'N/A';

                    // Columna 7: Fecha Creación
                    row.insertCell().textContent = formatDate(item.createAt);

                    // Columna 8: Acciones (Botones de cambio de estado)
                    const actionCell = row.insertCell();
                    actionCell.className = 'space-x-2';
                    
                    // Botón "Marcar como En Proceso"
                    if (item.estado === 'Pendiente') {
                        const processBtn = document.createElement('button');
                        processBtn.textContent = 'En Proceso';
                        processBtn.className = 'px-3 py-1 bg-blue-500 text-white text-sm font-semibold rounded-md hover:bg-blue-600 transition duration-150';
                        processBtn.onclick = () => handleStatusChange(item.id, 'En Proceso', processBtn);
                        actionCell.appendChild(processBtn);
                    } 
                    
                    // Botón "Marcar como Resuelta" (Disponible si no está resuelta)
                    if (item.estado !== 'Resuelta') {
                        const resolveBtn = document.createElement('button');
                        resolveBtn.textContent = 'Resolver';
                        resolveBtn.className = 'px-3 py-1 bg-green-500 text-white text-sm font-semibold rounded-md hover:bg-green-600 transition duration-150';
                        resolveBtn.onclick = () => handleStatusChange(item.id, 'Resuelta', resolveBtn);
                        actionCell.appendChild(resolveBtn);
                    }
                });

                loadingMessage.classList.add('hidden');
                tableContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Error fetching PQRSF data:', error);
                loadingMessage.classList.add('hidden');
                errorMessage.classList.remove('hidden');
            }
        };

        // Cargar datos al iniciar
        fetchPqrsfData();
    });
</script>

</body>
</html>